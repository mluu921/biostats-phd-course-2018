---
title: "ggplot2"
author: 
- 'Michael Luu'
- 'Marcio Diniz'
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
    toc: yes
---

# Loading Tidyverse and Data

```{r, message=F, warning=F}
library(tidyverse)

### Reading dataset

df <- read_csv("data/emergency.csv")

### Recoding variables

df <- df %>% mutate(infection =
                                 factor(infection,
                                        levels = 0:1,
                                        labels = c("No", "Yes")),
                               gender = 
                                 factor(gender,
                                        levels = 0:1,
                                        labels = c("Female", "Male")),
                               child =
                                 factor(child,
                                        levels = 0:2,
                                        labels = c("A", "B", "C")),
                               encephalopathy =
                                 factor(encephalopathy,
                                        levels = 0:1,
                                        labels = c("No", "Yes")),
                               ascites =
                                 factor(ascites,
                                        levels = 0:1,
                                        labels = c("No", "Yes")),
                               death = 
                                 factor(death,
                                        levels = 0:1,
                                        labels = c("No", "Yes")))



```

# What is ggplot2 ? 

![](figures/tidyverse.PNG)

> ggplot2 is part of the tidyverse suite of packages

> Based off of the grammar of graphics, with the idea of a standardized language used to build graphs by layers

## Resources

[R for Data Science](http://r4ds.had.co.nz/)

[Tidyverse Homepage](https://www.tidyverse.org/)

[R Studio Cheatsheets](https://www.rstudio.com/resources/cheatsheets/)

[ggplot2 Cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf)

<!-- # Grammar of Graphics -->
<!-- ![](figures/grammar_of_graphics.PNG) -->

# Building a Plot

![](figures/ggplot_documentation.PNG)

# My First Plot

> The actual full syntax of `ggplot()` is `ggplot(data = NULL, mapping = aes()`). R is smart enough that you don't need to specify the argument name as it automatically treats the first object specified as `data = df` and the second argument as `mapping = aes()`. That way `ggplot(df)` is equivalent to `ggplot(data = df)`.

```{r}
ggplot(data = df)

```

> Doesn't look very good! It's just a blank square - Let's try mapping a variable onto the x axis within the aes() argument

## Adding a coordinate system
```{r}
ggplot(df, aes(x = age))
```

> Great! We have now mapped the variable age onto the x axis - now lets try adding some geoms such as geom_dotplot

## Adding a geom (dotplot)
```{r}
ggplot(df, aes(x = age)) + 
  geom_dotplot()
```

### Making changes to the geom layer

> Great! Our first plot - it doesn't look very pretty such as the dots being very large spanning multiple age points. Let's update the plot using some of the arguments available inside geom_dotplot. I don't remember all of the available arguments, lets look up the documentation using ?geom_dotplot

![](figures/dotplot_documentation.PNG)

> A couple things to highlight, we want to use the histodot function because we want fixed binwidth instead of the default 'dotdensity' approach, we also want to adjust binwidht to 1 indicating 1 stacked column of dots per every age 

![](figures//dotplot_documentation2.PNG)

> Let's make those changes

```{r}
ggplot(df, aes(x = age)) + 
  geom_dotplot(method = 'histodot', binwidth = 1)
```

> Great! This is looking more like a dotplot, but it still doesn't look very pretty. Let's spice things up with themes.

## Themes

![](figures/ggplot2_themes.PNG)

> Some of the default themes that come from ggplot2, but there are many more that we can utilize from the ggthemes package! 

[https://cran.r-project.org/web/packages/ggthemes/vignettes/ggthemes.html](https://cran.r-project.org/web/packages/ggthemes/vignettes/ggthemes.html)

```{r}
ggplot(df, aes(x = age)) +
  geom_dotplot(binwidth = 1, method = "histodot") +
  theme_bw()
```

```{r}
ggplot(df, aes(x = age)) +
  geom_dotplot(binwidth = 1, method = "histodot") +
  theme_minimal()
```

```{r}
ggplot(df, aes(x = age)) +
  geom_dotplot(binwidth = 1, method = "histodot") +
  theme_classic()
```

### Utilizing themes from the ggthemes package

> Utilizing themes from the ggthemes package, if you dont have ggthemes then please install using `install.packages('ggthemes')` and loading up the library using `library(ggthemes)`

```{r}
# install.packages(ggthemes)
library(ggthemes)

# Theme matching the popular politics/analytics website firvethirtyeight
ggplot(df, aes(x = age)) +
  geom_dotplot(binwidth = 1, method = "histodot") +
  theme_fivethirtyeight()

```

```{r}

# Wallstreet journal
ggplot(df, aes(x = age)) +
  geom_dotplot(binwidth = 1, method = "histodot") +
  theme_wsj()
```

```{r}

# Economist
ggplot(df, aes(x = age)) +
  geom_dotplot(binwidth = 1, method = "histodot") +
  theme_economist()


```

```{r}
# Excel

ggplot(df, aes(x = age)) +
  geom_dotplot(binwidth = 1, method = "histodot") +
  theme_excel()
```

### Customizing a theme

> Lets continue on with theme_bw(), but make some customizations with the `theme()` function, by removing the ticks, the title, and the text for the y axis.

> We can do this by looking at the documentation for `theme()` using `?theme`

![](figures/theme_documentation.PNG)

> Alot of possible changes we can make but we will focus on the `axis.title.y`, `axis.text.y`, and the `axis.ticks.y` arguments.

> Almost all arguments in `theme()` needs to receive the information with the `element_blank()`, `element_text()`, `element_line()`, and `element_rect()` function. We will focus on `element_blank()` for now by using it to remove the information on the y axis.

```{r}
ggplot(df, aes(x = age)) +
  geom_dotplot(binwidth = 1, method = "histodot") +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```


## Adding and customizing the colors using the fill argument and the scale_fill_manual() / scale_fill_discrete() function

> Looks more like a dotplot now! But how about adding some color, by identifying the infection and non infection patients. We can do this using the `fill` argument and mapping it to the variable infection. Recall if we want to map any variables, we can only utilize those varaibles in the `aes()` argument.


```{r}
ggplot(df, aes(x = age, fill = infection)) +
  geom_dotplot(binwidth = 1, method = "histodot") +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

> Looks great but the x axis label 'age' doesn't look very good, lets capitalize it and fix the legend title. Doesn't look very 'publication ready'. We can do this by using the `labs()` function, and changing the x axis label. Since the color legend is mapped using the `fill` argument, we can make changes to the title by specifying it with the `scale_fill_discrete()` function.

### Customizing the x axis title and the legend title

> `scale_fill_discrete()` changes the scale name of the fill function manually as well as other options, but we'll focus on changing the name for now. By default, it uses the variable name but in this case we want to change it to something more pleasing and consistent with the rest of the plot.

```{r}
ggplot(df, aes(x = age, fill = infection)) +
  geom_dotplot(binwidth = 1, method = "histodot")  +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_discrete("Infection") +
  labs(x = "Age")
```


> Legend title is now fixed - however what if we want to have custom colors ? We can use the `scale_fill_manual()` instead and specify the colors manually via the values argument. Let's change it to black and green to see how it looks.

```{r}
ggplot(df, aes(x = age, fill = factor(infection))) +
  geom_dotplot(binwidth = 1, method = "histodot")  +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_manual("Infection", values = c('black', 'green')) +
  labs(x = "Age")
```

### Customizing the colors using palletes

> ggplot2 has a selection of built in color palletes so you dont have to specify your own, that are 'aesthetically pleasing'

![](figures/ggplot_pallete_colors.PNG)

Examples can be found on the ggplot2 tidyverse site
[http://ggplot2.tidyverse.org/reference/scale_brewer.html](http://ggplot2.tidyverse.org/reference/scale_brewer.html)

```{r}
ggplot(df, aes(x = age, fill = infection)) +
  geom_dotplot(binwidth = 1, method = "histodot")  +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_brewer("Infection", palette = "Set3") +
  labs(x = "Age")
```

```{r}
ggplot(df, aes(x = age, fill = infection)) +
  geom_dotplot(binwidth = 1, method = "histodot")  +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_brewer("Infection", palette = "Set2") +
  labs(x = "Age")
```

```{r}
ggplot(df, aes(x = age, fill = infection)) +
  geom_dotplot(binwidth = 1, method = "histodot")  +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_brewer("Infection", palette = "Set1") +
  labs(x = "Age")
```

> Let's choose 'Set1', to change our color pallete. We can specify the color pallete using the `scale_fill_brewer()` function. We will have to also include the updated scale name 'Infection' that way our legend title has the capitalized 'I'. We can specify the palette using the `palette` function and specify the 'Set1' color pallete.

> What if we don't want the dots to be stacked? We can utilize the facet option to stratify the infection and non infection patients

## Utilizing 'Facets' to separate our dotplot into groups

> We can use the `facet_grid()` function, this will stratify the dotplot by a selected variable such as `infection` by it's levels such as 'Yes', and 'No'

> Lets look at the documentation again

![](figures/facet_documentation.PNG)

> We will focus on the facets argument, which per the documentation requires a formula specifying the LHS (left hand side) and the RHS (right hand side) corresponding to rows ~ columns. A . (period) can be used as a placeholder indicating no 'facet' on that level. We can facet by columns upon the infection variable by indicating this formula . ~ infection in the `facet_grid()` function.

```{r}
ggplot(df, aes(x = age, fill = infection)) +
  geom_dotplot(binwidth = 1, method = "histodot")  +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_brewer("Infection", palette = "Set1") +
  labs(x = "Age") +
  facet_grid(. ~ infection)
```

> Lets try facet on the row to see how it looks. We can do this by flipping the formula by placing the variable infection on the LHS.

```{r}
ggplot(df, aes(x = age, fill = infection)) +
  geom_dotplot(stackgroups = TRUE, binwidth = 1, method = "histodot")  +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_brewer("Infection", palette = "Set1") +
  labs(x = "Age") +
  facet_grid(infection ~ .)
```

> Now that we have faceted the plot, the legend isn't very informative anymore and its redundant. Lets remove it!

## Removing the legend
```{r}
ggplot(df, aes(x = age, fill = infection)) +
  geom_dotplot(binwidth = 1, method = "histodot")  +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none") +
  scale_fill_brewer("Infection", palette = "Set1") +
  labs(x = "Age") +
  facet_grid(. ~ infection)
```

> The plot is really starting to come together, but what if we want to change the scale of the x axis ? We want it to be spaced by every 5 years of age instead of 10 ?

## Changing the x axis scale

> We can do this by utilizing the `scale_x_continuous()` function. Per the documentation, one of the arguments is `breaks` which specifies the breaks in the scale and it requires a vector of numbers for the breaks. We can specify it by typing `c(15, 20, 25, ...)` but as programmers we are lazy, and can utilizing the `seq()` function which returns a vector of numbers from a specified range. `seq(0, 100, 1)` will produce a vector of numbers from 0 to 100 by 1.

```{r}
seq(0,100,1)
```

> We can use this in the breaks argument as shown below to specify the range. ggplot2 is smart that it will limit the view of the x axis that is within reasonable range of the data. Just to be safe we'll use `seq(from = 0, to = 100, by = 5)` to create a vector of numbers from 0 to 100 by 5

```{r}
ggplot(df, aes(x = age, fill = infection)) +
  geom_dotplot(binwidth = 1, method = "histodot", binpositions="bygroup")  +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none") +
  scale_fill_brewer("Infection", palette = "Set1") +
  labs(x = "Age") +
  facet_grid(. ~ infection) +
  scale_x_continuous(breaks = seq(0,100, 5))
```

## Another perspective with dotplots (Vertical bins)

> What if we want to compare the distribution of Infection (No vs Yes) side by side ? We will need to map the infection variable to the x axis and move the age variable to the y axis. We'll also keep the infection variable with the `fill` argument that way it'll retain the color

```{r}
ggplot(df, aes(y = age, x = infection, fill = infection))
```

> Now we have the basis of the plot, we can add the dotplot geom once again, except we'll bin the histodots on the y axis instead of x and keep the stack them aligned to the center.

```{r}
ggplot(df, aes(y = age, x = infection, fill = infection)) +
  geom_dotplot(binaxis = "y", stackdir = "center",
               binwidth = 1, method = "histodot")
```

> Now let's add some descriptive indicators on the plot via the `stat_summary()` function. Let's add an indicator of the medians for both the non infection group and the infection group. `stat_summary()` allows us to map a function to the y axis. We will use the `median` function to accomplish this, and use the geom crossbar to visualize the measure.

```{r}
ggplot(df, aes(y = age, x = infection, fill = infection)) +
  geom_dotplot(binaxis = "y", stackdir = "center",
               binwidth = 1, method = "histodot") +
  stat_summary(fun.y = median, fun.ymin = median, fun.ymax = median, geom = "crossbar", width = 0.5) 
```

> Let's finish cleaning up the plot with some of the other functions we have learned

```{r}

# manually calculate the median age by infection group

ggplot(df, aes(y = age, x = infection, fill = infection)) +
  geom_dotplot(binaxis = "y", stackdir = "center",
               binwidth = 1, method = "histodot") +
  stat_summary(fun.y = median, fun.ymin = median, fun.ymax = median, geom = "crossbar", width = 0.3) +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank()) +
  scale_fill_brewer("infection", palette = "Set1") +
  labs(y = "Age", x = "Infection", title = 'Distriubtion of Age Stratified by Infection') +
  scale_y_continuous(breaks = seq(0,100, 10))
```

# Saving the plot we just made

> Now that we are happy with the plot we just made, we should save it so we can share it with our collaborators.  There are we can do this by invoking the `ggsave()` function. By default `ggsave()` will save the last plot that was rendered, however we can also specify the plot we would like to save as well.

> The command for `ggsave()` is `ggsave(filename = NULL, plot = last_plot(), ...)`. Please see the documentation for further details using `?ggsave`, for other possible arguments to configure.

```{r}
ggsave('my_first_plot.png', height = 6, width = 8)
```

> This function will save the previous plot, in your project directory as my_first_plot.png, with a height of 6 inches, and a width of 8 inches.
